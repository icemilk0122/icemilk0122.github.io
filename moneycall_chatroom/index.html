<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1;maximum-scale=1.0; user-scalable=0;">
    <link rel="stylesheet" href="https://necolas.github.io/normalize.css/7.0.0/normalize.css">
    <link rel="stylesheet" href="css/index.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-url-parser/2.3.1/purl.min.js"></script>
    <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
  </head>
  <body>
    <div class="chat" id="listMessages">
      <ul></ul>
    </div>

    <div class="enter-message" id="newMessage">
      <input type="text" name="text" placeholder="Enter your message.."/>
      <a href="javascript:void(0)" class="send">Send</a>
    </div>
  </body>
  <script type="text/javascript">
  (function() {
    var SimpleChat, myChatApp;
    var url = $.url(location.href);
    var roomNum = url.param('id');
    //聊天室顯示名稱，client端固定是Jeff
    var chatname = (url.param('chatname')==undefined)?"stranger":url.param('chatname');

    SimpleChat = (function() {
      var fireBase;

      fireBase = new Firebase("https://moneycall-chat.firebaseio.com/"+roomNum);

      function SimpleChat() {
        //讀取聊天室內容，如果沒有資料會自動塞一筆預設對話
        fireBase.on('value', (function(_this) {
          return function(snapshot) {
            if(snapshot.val()==null)
            {
              return _this.messagesView('Jeff', 'Hi, 我是 Jeff，這裡是臨時線上聊天室。請留言給我，我會儘快回覆你。');
            }
          };
        })(this));

        //偵聽聊天室有沒有新訊息，有的話會將資料更新到畫面上
        fireBase.on("child_added", (function(_this) {
          return function(snapshot) {
            var message;
            message = snapshot.val();
            return _this.messagesView(message.name, message.text);
          };
        })(this));

        //按下enter或send按鈕會將訊息送出
        $("#newMessage input").keypress((function(_this) {
          return function(e) {
            var text;
            if (e.keyCode === 13) {
              _this.sendNewMessage();
            }
          };
        })(this));
        $(".send").click((function(_this) {
          return function(e) {
              _this.sendNewMessage();
          };
        })(this));
      }

      //送出新訊息後將輸入框清空
      SimpleChat.prototype.sendNewMessage = function(){
        var text;
        text = $("#newMessage input[name='text']").val();
        $("#newMessage input[name='text']").val("");
        return this.newMessage(chatname, text);
      }

      //更新訊息到畫面上，如果name是Jeff會套用class me，其餘都是them
      SimpleChat.prototype.messagesView = function(name, text) {
        var listItem, nameItem, textItem;
        listItem = jQuery("<li/>");
        textItem = jQuery("<p/>", {
          "class": (name == "Jeff")?"me":"them",
          text: text
        });
        listItem.appendTo("#listMessages ul");
        textItem.appendTo(listItem);
        return;
      };

      //將新訊息推到firebase
      SimpleChat.prototype.newMessage = function(name, text) {
        return fireBase.push({
          name: name,
          text: text
        });
      };

      return SimpleChat;

    })();

    myChatApp = new SimpleChat;

    }).call(this);
  </script>
</html>
